<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Doctors to Courses</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/base.css">
    <link rel="stylesheet" href="../assets/css/assign_doctors.css">
</head>
<body>
    <div class="container">
        <h2>Assign Doctors to Courses</h2>
        
        <div class="form-section">
            <div class="course-selection">
                <label for="courseSelect">Select Course:</label>
                <select id="courseSelect" onchange="onCourseSelect()">
                    <option value="">Select a course</option>
                </select>
                <div id="courseInfo" class="course-info"></div>
            </div>

            <div id="loading" class="loading">Loading...</div>
            <div id="noData" class="no-data" style="display: none;">No doctors available for assignment.</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <form id="assignmentForm" onsubmit="submitAssignments(event)" style="display: none;">
                <div class="table-container">
                    <table id="doctorsTable">
                        <thead>
                            <tr>
                                <th>Doctor Name</th>
                                <th>Email</th>
                                <th>Lecturer</th>
                                <th class="lab-column">Lab Instructor</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="button-container">
                    <button type="submit" class="save-btn" id="saveButton">Save Assignments</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let courseHasLab = false;
        document.addEventListener('DOMContentLoaded', loadCourses);

        function showError(message, isSuccess = false) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.className = isSuccess ? 'success-message' : 'error-message';
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('noData').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        async function loadCourses() {
            showLoading(true);
            try {
                const response = await fetch('../api/fetch_courses.php?purpose=assignment');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load courses');
                }

                const courseSelect = document.getElementById('courseSelect');
                courseSelect.innerHTML = '<option value="">Select a course</option>';

                if (!data.data || data.data.length === 0) {
                    showError('No courses available for assignment');
                    return;
                }

                data.data.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.courseCode;
                    option.textContent = `${course.courseCode} - ${course.courseName}`;
                    option.dataset.hasLab = course.has_lab ? 'true' : 'false';
                    option.dataset.lecturerCount = course.lecturer_count;
                    option.dataset.labInstructorCount = course.lab_instructor_count;
                    courseSelect.appendChild(option);
                });

                showLoading(false);

            } catch (error) {
                console.error('Error:', error);
                showError('Failed to load courses: ' + error.message);
            }
        }

        function updateCourseInfo(selectedOption) {
            const courseInfo = document.getElementById('courseInfo');
            if (!selectedOption.value) {
                courseInfo.innerHTML = '';
                return;
            }

            const hasLab = selectedOption.dataset.hasLab === 'true';
            const lecturerCount = parseInt(selectedOption.dataset.lecturerCount) || 0;
            const labInstructorCount = parseInt(selectedOption.dataset.labInstructorCount) || 0;

            courseInfo.innerHTML = `
                <div class="info-item">
                    <span class="label">Lecturers:</span>
                    <span class="value ${lecturerCount > 0 ? 'assigned' : 'needed'}">
                        ${lecturerCount} assigned
                    </span>
                </div>
                ${hasLab ? `
                    <div class="info-item">
                        <span class="label">Lab Instructors:</span>
                        <span class="value ${labInstructorCount > 0 ? 'assigned' : 'needed'}">
                            ${labInstructorCount} assigned
                        </span>
                    </div>
                ` : ''}
            `;
        }

        async function onCourseSelect() {
            const courseSelect = document.getElementById('courseSelect');
            const selectedOption = courseSelect.options[courseSelect.selectedIndex];
            const form = document.getElementById('assignmentForm');
            
            form.style.display = 'none';
            showLoading(true);
            
            if (!selectedOption.value) {
                updateCourseInfo(selectedOption);
                return;
            }

            courseHasLab = selectedOption.dataset.hasLab === 'true';
            updateCourseInfo(selectedOption);

            // Show/hide lab instructor column
            const labColumns = document.querySelectorAll('.lab-column');
            labColumns.forEach(col => {
                col.style.display = courseHasLab ? 'table-cell' : 'none';
            });

            await loadDoctors(selectedOption.value);
        }

        async function loadDoctors(courseCode) {
            try {
                const response = await fetch(`../api/fetch_doctors.php?courseCode=${encodeURIComponent(courseCode)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load doctors');
                }

                const tbody = document.querySelector('#doctorsTable tbody');
                tbody.innerHTML = '';

                if (!data.data || data.data.length === 0) {
                    document.getElementById('noData').style.display = 'block';
                    showLoading(false);
                    return;
                }

                data.data.forEach(doctor => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${doctor.docName}</td>
                        <td>${doctor.email}</td>
                        <td class="checkbox-cell">
                            <label class="checkbox-container">
                                <input type="checkbox" name="lecturer_${doctor.docID}" 
                                    ${doctor.isLecturer ? 'checked' : ''} />
                                <span class="checkmark"></span>
                            </label>
                        </td>
                        <td class="checkbox-cell lab-column" style="display: ${courseHasLab ? 'table-cell' : 'none'}">
                            <label class="checkbox-container">
                                <input type="checkbox" name="lab_${doctor.docID}"
                                    ${doctor.isLabInstructor ? 'checked' : ''} />
                                <span class="checkmark"></span>
                            </label>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('assignmentForm').style.display = 'block';
                showLoading(false);

            } catch (error) {
                console.error('Error:', error);
                showError('Error loading doctors: ' + error.message);
            }
        }

        async function submitAssignments(event) {
            event.preventDefault();
            showLoading(true);

            const courseCode = document.getElementById('courseSelect').value;
            if (!courseCode) {
                showError('Please select a course first.');
                return;
            }

            const assignments = [];
            let lecturerFound = false;
            let labFound = false;

            document.querySelectorAll('#doctorsTable tbody tr').forEach(row => {
                const docID = row.querySelector('input[name^="lecturer_"]')
                    .getAttribute('name')
                    .replace('lecturer_', '');

                const isLecturer = row.querySelector(`input[name="lecturer_${docID}"]`).checked;
                const isLabInstructor = courseHasLab && 
                    row.querySelector(`input[name="lab_${docID}"]`)?.checked;

                if (isLecturer) lecturerFound = true;
                if (isLabInstructor) labFound = true;

                if (isLecturer || isLabInstructor) {
                    assignments.push({
                        docID,
                        isLecturer: isLecturer ? 1 : 0,
                        isLabInstructor: isLabInstructor ? 1 : 0
                    });
                }
            });

            if (!lecturerFound) {
                showError('You must assign at least one lecturer for this course.');
                return;
            }

            if (courseHasLab && !labFound) {
                showError('This course requires a lab instructor. Please select at least one.');
                return;
            }

            try {
                const response = await fetch('../api/save_doctor_assignment.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseCode,
                        assignments,
                        courseHasLab
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Failed to save assignments');
                }

                showError('Assignments saved successfully!', true);
                await loadCourses(); // Reload courses to update counts
                await loadDoctors(courseCode); // Reload doctors to show updated assignments

            } catch (error) {
                console.error('Error:', error);
                showError('Error saving assignments: ' + error.message);
            }
        }
    </script>
</body>
</html>
